<?php namespace App\Controllers\Api\Tokopedia;

use App\Controllers\Api\Tokopedia\MyResourceTokopedia;

class Payment extends MyResourceTokopedia
{
    public function beliPulsa()
    {
        if ($this->validate([
            'msisdn' => 'required|numeric',
            'produkId' => 'required',
        ], $this->validationMessage)) {
            $msisdn = $this->request->getPost('msisdn');
            $produkId = $this->request->getPost('produkId');

            // $response = $this->tokpedApi->beliPulsa($msisdn, $produkId);
            $response = $this->tokpedPaymentApi->paymentHtmlPage('Items=%7B0+TKP+PULSA+%5B4+-+2.000+%28089651312000%29%5D+1+2323%7D&SubscriptionToken=&SubscriptionUUID=&ValidationType=&additional_fee=&amount=2323&currency=IDR&customer_email=&customer_msisdn=6281392234427&customer_name=Ahmad+Juhdi&expired_on=&fee=&items%5Bname%5D=TKP+PULSA+%5B4+-+2.000+%28089651312000%29%5D&items%5Bprice%5D=2323&items%5Bquantity%5D=1&language=id-ID&merchant_code=tokopediapulsa&nid=&payment_identifier=&payment_metadata=%7B%22user_data%22%3A%7B%22device_id%22%3A%22%22%2C%22device_version%22%3A%22%22%2C%22device_type%22%3A%22android-mitra%22%2C%22dg_loyalty_status%22%3A%22%22%7D%2C%22order_data%22%3A%7B%22order_data%22%3A%5B%7B%22order_id%22%3A%221277342642%22%2C%22order_code%22%3A%22IVR%2F20220730%2FXXII%2FVII%2F1277379364%22%2C%22product_code%22%3A%22pulsa%22%2C%22invoice_url%22%3A%22https%3A%2F%2Fpulsa.tokopedia.com%2Finvoice%2F%3Fpdf%3DInvoice-Recharge-214418099-1443-20220730205144-N38rW7Bvv81z.pdf%5Cu0026id%3D1277342642%22%2C%22product_data%22%3A%5B%7B%22operator_id%22%3A%224%22%2C%22product_id%22%3A%221443%22%2C%22product_name%22%3A%22Tri+2.000%22%2C%22product_code%22%3A%22TRI2K%22%2C%22price%22%3A2323%2C%22quantity%22%3A1%2C%22campaign_id%22%3A%22%22%2C%22client_number%22%3A%22089651312000%22%2C%22identity_number%22%3A%22%22%2C%22is_product_pre_order%22%3Afalse%2C%22product_category%22%3A%7B%22id%22%3A1%2C%22name%22%3A%22Pulsa%22%2C%22identifier%22%3A%22Beli+Pulsa%22%2C%22parent%22%3A0%7D%7D%5D%2C%22expire_time%22%3A%220001-01-01T00%3A00%3A00Z%22%7D%5D%7D%2C%22promo_data%22%3A%7B%22voucher_code%22%3A%22%22%2C%22promo_code_id%22%3A0%2C%22payment_description%22%3A%22%22%2C%22subsidized_amount%22%3A0%2C%22total_discount%22%3A0%2C%22total_cashback%22%3A0%2C%22is_stacking%22%3Afalse%7D%2C%22config_data%22%3A%7B%22hide_header_flag%22%3Afalse%2C%22device%22%3A0%2C%22is_verified_msisdn%22%3Atrue%2C%22va_code%22%3A%22%22%2C%22thanks_data%22%3A%7B%22custom_order_url%22%3A%22https%3A%2F%2Fm.tokopedia.com%2Forder-details%2Fdigital%2F1277342642%3FbackBtn%3Dfalse%5Cu0026upstream%3DDIGITAL%22%2C%22custom_order_url_app%22%3A%22tokopedia%3A%2F%2Fdigital%2Forder%2F1277342642%22%2C%22custom_home_url%22%3A%22https%3A%2F%2Fwww.tokopedia.com%2Flangganan%2Fadd%3Faction%3Dadd_subscription%5Cu0026client_number%3D089651312000%5Cu0026due_date%3D%5Cu0026label%3D%5Cu0026menu_id%3D148%5Cu0026name%3DPulsa%5Cu0026operator_id%3D4%5Cu0026payment_type%3D%5Cu0026product_id%3D1443%5Cu0026repeat_type%3D3%5Cu0026uuid%3D%22%2C%22custom_home_url_app%22%3A%22tokopedia%3A%2F%2Fwebview%3Ftitlebar%3Dfalse%5Cu0026url%3Dhttps%253A%252F%252Fwww.tokopedia.com%252Flangganan%252Fadd%253Faction%253Dadd_subscription%2526client_number%253D089651312000%2526due_date%253D%2526label%253D%2526menu_id%253D148%2526name%253DPulsa%2526operator_id%253D4%2526payment_type%253D%2526product_id%253D1443%2526repeat_type%253D3%2526uuid%253D%22%2C%22custom_title%22%3A%22Selamat%2C+pembayaran+Tri+2.000+berhasil%21%22%2C%22custom_subtitle%22%3A%22Kamu+bisa+cek+status+transaksimu+di+Detail+Transaksi%2C+ya.%22%2C%22custom_title_order_button%22%3A%22Lihat+Detail+Transaksi%22%2C%22custom_wtv_text%22%3A%22Transaksimu+baru+dilanjutkan+setelah+pembayaran+terverifikasi.%22%2C%22custom_title_home_button%22%3A%22Mulai+Berlangganan%22%2C%22tracking_data%22%3A%22%5B%7B%5C%22event%5C%22%3A+%5C%22transaction%5C%22%2C%5C%22eventCategory%5C%22%3A+%5C%22digital+-+thanks%5C%22%2C%5C%22eventAction%5C%22%3A+%5C%22view+purchase+attempt%5C%22%2C%5C%22eventLabel%5C%22%3A+%5C%22Pulsa+-+Tri+-+Waiting+Payment+-+1%5C%22%2C%5C%22currentSite%5C%22%3A+%5C%22tokopediadigital%5C%22%2C%5C%22environment%5C%22%3A+%5C%22other%5C%22%2C%5C%22loginStatus%5C%22%3A+%5C%221%5C%22%2C%5C%22userId%5C%22%3A+%5C%22214418099%5C%22%2C%5C%22siteName%5C%22%3A+%5C%22Recharge+Site%5C%22%2C%5C%22businessUnit%5C%22%3A+%5C%22payment%5C%22%2C%5C%22payment_id%5C%22%3A+%5C%222274676209%5C%22%2C%5C%22ecommerce%5C%22%3A+%7B%5C%22currencyCode%5C%22%3A+%5C%22IDR%5C%22%2C%5C%22purchase%5C%22%3A+%7B%5C%22actionField%5C%22%3A+%7B%5C%22id%5C%22%3A+%5C%221277342642%5C%22%2C%5C%22revenue%5C%22%3A+%5C%222323.00%5C%22%2C%5C%22tax%5C%22%3A+%5C%22%5C%22%2C%5C%22coupon%5C%22%3A+%5C%22%5C%22%7D%2C%5C%22products%5C%22%3A+%5B%7B%5C%22name%5C%22%3A+%5C%22Tri+2.000%5C%22%2C%5C%22id%5C%22%3A+%5C%221443%5C%22%2C%5C%22price%5C%22%3A+%5C%222323.00%5C%22%2C%5C%22quantity%5C%22%3A+%5C%221%5C%22%7D%5D%7D%7D%2C%5C%22categoryId%5C%22%3A+%5C%221%5C%22%2C%5C%22categoryName%5C%22%3A+%5C%22Pulsa%5C%22%2C%5C%22operator%5C%22%3A+%5C%22Tri%5C%22%2C%5C%22profileId%5C%22%3A%5C%22PULSA_MITRA_DEFAULT%5C%22%2C+%5C%22datalayer_id%5C%22%3A8287%7D%5D%22%2C%22thank_you_page_token%22%3A%22lCZ0gkU9Og3LDl3x4kSaDVEt5R039wGeb1fEofO7Ct7c52yqlVCcKZiwYYlG8MnJ_tqxBYDDeQiOegVgEJ3fYg%22%2C%22hide_search_bar%22%3Afalse%2C%22hide_global_menu%22%3Afalse%2C%22hide_feature_recom%22%3Afalse%2C%22hide_pg_recom%22%3Afalse%2C%22hide_dg_recom%22%3Afalse%7D%7D%7D&pid=56668393290836115193854&profile_code=PULSA_MITRA_DEFAULT&signature=7a66c801cd8f3c0179673f3681fd49033c222837&state=0&transaction_code=&transaction_date=2022-07-30T13%3A51%3A44Z&transaction_id=2274676209&user_defined_value=%7B%22user_id%22%3A214418099%2C%22voucher_code%22%3A%22%22%2C%22device%22%3A1%2C%22product_id%22%3A1443%2C%22price%22%3A2323%2C%22client_number%22%3A%22089651312000%22%2C%22payment_description%22%3A%22%22%2C%22promo_code_id%22%3A0%2C%22discount_amount%22%3A0%2C%22cashback_amount%22%3A0%2C%22cashback_voucher_amount%22%3A0%2C%22cashback_top_cash_amount%22%3A0%2C%22va_code%22%3A%22081392234427%22%2C%22fingerprint_id%22%3A%22%22%2C%22hide_header_flag%22%3Afalse%2C%22category_code%22%3A%221%22%2C%22product_code%22%3A%22TRI2K%22%2C%22is_mitra%22%3Atrue%2C%22order_type%22%3A7%2C%22coda_amount%22%3A0%2C%22product_name%22%3A%22Tri+2.000%22%2C%22product_name_en%22%3A%22Tri+2.000%22%2C%22xshop_flag%22%3A0%2C%22api_key%22%3A%22%22%2C%22is_stacking%22%3Afalse%7D');
            echo '<pre>';
            print_r($response);
            echo '</pre>';exit;

            if(isset($response['express_checkout']['status']) && $response['express_checkout']['status']){
                return $this->response($response);
            } else {
                return $this->response(null, 400, $response);
            }

            return $this->response($response);
        } else {
            return $this->response(null, 400, $this->validator->getErrors());
        }
      
    }
}
